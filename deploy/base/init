#!/usr/bin/env bash

### BEGIN ###
# Author: idevz
# Since: 2018/03/12
# Description:       Set up Base pvm
# ./init.sh          Set up using $(pwd) as BASE_DIR, down which has go source and binaries.
#
# Environment variables that control init:
# SIP: default static ip.
### END ###

set -e

[ -z $PRLCTL_HOME ] && PRLCTL_HOME=/media/psf/runX
STATIC_IP=${SIP:-"10.211.55.100"}
BASE_DIR=${BASE_DIR:-"$(readlink -f "$(dirname "$0")")"}

# manualset eth0
eth0_setting() {
	ETH0_CONF=$(
		cat <<ETH0
# Generated by parse-kickstart
DEVICE="eth0"
IPV6INIT="yes"
BOOTPROTO="static"
ONBOOT="yes"
IPADDR="10.211.55.100"
NETMASK="255.255.255.0"
GATEWAY="10.211.55.1"
ETH0
	)

	echo "${ETH0_CONF}" | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
	sudo ifdown eth0 && sudo ifup eth0
}

pre_install_parallels_tools() {
	sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm dkms \
		ftp://ftp.pbone.net/mirror/ftp.scientificlinux.org/linux/scientific/7.2/x86_64/updates/security/kernel-devel-3.10.0-693.el7.x86_64.rpm
}

# install_parallels_tools manual install
install_parallels_tools() {
	pre_install_parallels_tools
	[ ! -d /media/cdrom ] && sudo mkdir /media/cdrom
	sudo mount | grep iso9660
	sudo umount /dev/cdrom \
		mount -o exec /dev/cdrom /media/cdrom \
		cd /media/cdrom/ \
		./install
}

using_zsh() {
	sudo yum install -y zsh
	local zsh_location=$(which zsh)
	echo ${zsh_location} | sudo tee -a /etc/shells
	chsh -s ${zsh_location}
	sudo chsh -s ${zsh_location}
}

init_etc() {
	sudo hostnamectl set-hostname base
	using_zsh
	sudo cp "${PRLCTL_HOME}/shell/etc-sudoers" /etc/sudoers
	sudo cp "${PRLCTL_HOME}/shell/etc-profile" /etc/profile
	cp "${PRLCTL_HOME}/shell/runX.zshrc" ~/.zshrc
	sudo cp "${PRLCTL_HOME}/shell/runX.zshrc" ~/.zshrc
}

install_gdb() {
	[ ! -f "${BASE_DIR}/srcs/gdb-8.2.tar.gz" ] &&
		curl -fSL ftp://ftp.gnu.org/gnu/gdb/gdb-8.2.tar.gz -o ${BASE_DIR}/srcs/gdb-8.2.tar.gz
	sudo yum -y install gcc-c++ #configure: error: *** A compiler with support for C++11 language features is required.
	sudo yum install -y texinfo #makeinfo error when running make install
	[ ! -f "${BASE_DIR}/srcs/lzma-libs-4.32.7-1.el7.rf.x86_64.rpm" ] &&
		curl -fSL http://ftp.tu-chemnitz.de/pub/linux/dag/redhat/el7/en/x86_64/rpmforge/RPMS/lzma-libs-4.32.7-1.el7.rf.x86_64.rpm -o ${BASE_DIR}/srcs/lzma-libs-4.32.7-1.el7.rf.x86_64.rpm
	sudo yum --nogpgcheck -y localinstall ${BASE_DIR}/srcs/lzma-libs-4.32.7-1.el7.rf.x86_64.rpm
	[ ! -f "${BASE_DIR}/srcs/lzma-devel-4.32.7-1.el7.rf.x86_64.rpm" ] &&
		curl -fSL http://ftp.tu-chemnitz.de/pub/linux/dag/redhat/el7/en/x86_64/rpmforge/RPMS/lzma-devel-4.32.7-1.el7.rf.x86_64.rpm -o ${BASE_DIR}/srcs/lzma-devel-4.32.7-1.el7.rf.x86_64.rpm
	sudo yum --nogpgcheck -y localinstall ${BASE_DIR}/srcs/lzma-devel-4.32.7-1.el7.rf.x86_64.rpm
	[ ! -f "${BASE_DIR}/srcs/lzma-4.32.7-1.el7.rf.x86_64.rpm" ] &&
		curl -fSL http://ftp.tu-chemnitz.de/pub/linux/dag/redhat/el7/en/x86_64/rpmforge/RPMS/lzma-4.32.7-1.el7.rf.x86_64.rpm -o ${BASE_DIR}/srcs/lzma-4.32.7-1.el7.rf.x86_64.rpm
	sudo yum --nogpgcheck -y localinstall ${BASE_DIR}/srcs/lzma-4.32.7-1.el7.rf.x86_64.rpm

	# gdb cannot read .gnu_debugdata sections because gdb lacks LZMA support
	# not good after install three above, but after below, is ok
	sudo yum install -y xz xz-devel

	sudo yum install -y ncurses-devel           # for add TUI support

	sudo yum install -y python36-devel python36 # add python support
	cd "${BASE_DIR}/srcs/"
	[ -d "${BASE_DIR}/srcs/gdb-8.2" ] && rm -rf "${BASE_DIR}/srcs/gdb-8.2"
	tar zxf gdb-8.2.tar.gz
	cd "${BASE_DIR}/srcs/gdb-8.2"
	./configure --prefix=/usr/local/gdb-8.2 --with-lzma --enable-tui --enable-plugins --enable-profiling --enable-gdbserver --with-python=/usr/bin/python36
	make -j4
	sudo make install -j4
	cd -
}

yum_packages() {
	sudo yum install -y strace dtrace weighttp \
		nc tree git patch patchelf nmon perf ntpdate \
		tcpdump psmisc zsh gcc gcc-c++
	install_gdb
	sudo yum list installed 'kernel*' | grep -v $(uname -r | sed 's/\.x86_64//g') | awk '{print $1}' | xargs sudo yum remove -y
}

init_etc
yum_packages
