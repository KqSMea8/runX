#!/usr/bin/env bash

### BEGIN ###
# Author: idevz
# Since: 2018/03/12
# Description:       Set up Base pvm
# ./init.sh          Set up using $(pwd) as BASE_DIR, down which has go source and binaries.
#
# Environment variables that control init:
# SIP: default static ip.
### END ###

set -e

[ -z $PRLCTL_HOME ] && PRLCTL_HOME=/media/psf/runX
STATIC_IP=${SIP:-"10.211.55.100"}
BASE_DIR=${BASE_DIR:-"$(readlink -f "$(dirname "$0")")"}

# manualset eth0
eth0_setting() {
	ETH0_CONF=$(
		cat <<ETH0
# Generated by parse-kickstart
DEVICE="eth0"
IPV6INIT="yes"
BOOTPROTO="static"
ONBOOT="yes"
IPADDR="10.211.55.100"
NETMASK="255.255.255.0"
GATEWAY="10.211.55.1"
ETH0
	)

	echo "${ETH0_CONF}" | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
	sudo ifdown eth0 && sudo ifup eth0
}

pre_install_parallels_tools() {
	sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm dkms \
		ftp://ftp.pbone.net/mirror/ftp.scientificlinux.org/linux/scientific/7.2/x86_64/updates/security/kernel-devel-3.10.0-693.el7.x86_64.rpm
}

# install_parallels_tools manual install
install_parallels_tools() {
	pre_install_parallels_tools
	[ ! -d /media/cdrom ] && sudo mkdir /media/cdrom
	sudo mount | grep iso9660
	sudo umount /dev/cdrom \
		mount -o exec /dev/cdrom /media/cdrom \
		cd /media/cdrom/ \
		./install
}

using_zsh() {
	sudo yum install -y zsh
	local zsh_location=$(which zsh)
	echo ${zsh_location} | sudo tee -a /etc/shells
	chsh -s ${zsh_location}
	sudo chsh -s ${zsh_location}
}

init_etc() {
	sudo hostnamectl set-hostname base
	using_zsh
	sudo cp "${PRLCTL_HOME}/shell/etc-sudoers" /etc/sudoers
	sudo cp "${PRLCTL_HOME}/shell/etc-profile" /etc/profile
	cp "${PRLCTL_HOME}/shell/runX.zshrc" ~/.zshrc
	sudo cp "${PRLCTL_HOME}/shell/runX.zshrc" ~/.zshrc
}

yum_packages() {
	sudo yum install -y strace dtrace weighttp \
		nc tree git patch patchelf nmon perf ntpdate \
		tcpdump psmisc zsh
}

init_etc
yum_packages
