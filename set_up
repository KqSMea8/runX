#!/usr/bin/env bash

### BEGIN ###
# Author: idevz
# Since: 2018/03/12
# Description:   An entrypoint script in the parallels vm.
# prlctl exec golang 'sudo -Hiu z set_up'
### END ###

set -e

[ -z $PRLCTL_HOME ] && PRLCTL_HOME=/media/psf/runX
[ $HOME != '/home/z' ] && echo 'Are U Z ?' && exit 1
HOSTNAME=$(hostname)
BASE_DIR=$(dirname $(cd $(dirname "$0") && pwd -P)/$(basename "$0"))

# create a profile for each host such as envriment variable setting
create_profile() {
	[ -z "$1" ] && echo "empty profile content." && exit 1
	PROFILE_FILE=/etc/profile.d/idevz_prlctl_${HOSTNAME}.sh
	[ -f ${PROFILE_FILE} ] && sudo rm ${PROFILE_FILE}
	echo "$1" | sudo tee -a /etc/profile.d/idevz_prlctl_${HOSTNAME}.sh
	# sudo sh -c "echo zzz >> /etc/profile"
	sudo chmod +x ${PROFILE_FILE}
}

init_gdb() {
	GDB_INIT_F=$(
		cat <<GDB_INIT
set python print-stack full
set history save on
set history remove-duplicates 1
set history filename ${PRLCTL_HOME}/gdb/$(hostname)/.gdb_history
source ${PRLCTL_HOME}/gdb/$(hostname)/.gdbinit
GDB_INIT
	)
	sudo cat >/root/.gdbinit <<GDB_INIT
set python print-stack full
set history save on
set history remove-duplicates 1
set history filename ${PRLCTL_HOME}/gdb/$(hostname)/.gdb_history
source ${HOME}/.gdbinit.d/lua.gdbinit

export HISTFILE=$PRLCTL_HOME/zsh/$(hostname)${HOME}/.zsh_history

directory /media/psf/code/z/to-or/tools/openresty-gdb-utils

py import sys
py sys.path.append("/media/psf/code/z/to-or/tools/openresty-gdb-utils")

source luajit20.gdb
source ngx-lua.gdb
source luajit21.py
source ngx-raw-req.py

set python print-stack full
set history save on
set history filename /media/psf/runX/openresty/.gdbinit.d/.gdb_history
GDB_INIT
	sudo cat >/root/.gdbinit <<GDB_INIT
set python print-stack full
GDB_INIT
}

init_zsh() {

}

base_init() {}

case ${1} in
rp | recreate_profile)
	BASE_DIR=$BASE_DIR/${HOSTNAME} && . $BASE_DIR/init
	create_profile "${PROFILE}"
	;;
*)
	BASE_DIR=$BASE_DIR/${HOSTNAME} && . $BASE_DIR/init
	init
	;;
esac
